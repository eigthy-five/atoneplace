<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>atoneplace</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <style>
    /* ───── Reset & Base ───── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface-hover: #1a1a1a;
      --border: #232323;
      --text: #e5e5e5;
      --text-muted: #777;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --green: #22c55e;
      --red: #ef4444;
      --radius: 12px;
      --transition: 0.2s ease;
    }

    [data-theme="light"] {
      --bg: #f5f5f5;
      --surface: #ffffff;
      --surface-hover: #fafafa;
      --border: #e5e5e5;
      --text: #1a1a1a;
      --text-muted: #666;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --green: #16a34a;
      --red: #dc2626;
    }

    html {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100dvh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* ───── Header ───── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header-actions { display: flex; align-items: center; gap: 8px; }

    .icon-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      width: 38px;
      height: 38px;
      border-radius: 10px;
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 18px;
      transition: background var(--transition);
    }

    .icon-btn:hover { background: var(--surface-hover); }

    /* ───── Page Selector ───── */
    #page-select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 32px 8px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      outline: none;
      transition: border-color var(--transition);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23777' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    #page-select:focus { border-color: var(--accent); }

    [data-theme="light"] #page-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    }

    /* ───── Main Content ───── */
    #page-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 16px 100px;
    }

    /* ───── Finance Table ───── */
    .finance-table {
      width: 100%;
      border-collapse: collapse;
    }

    .finance-table thead th {
      position: sticky;
      top: 57px;
      background: var(--bg);
      padding: 12px 0;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      z-index: 5;
    }

    .finance-table thead th:first-child { text-align: left; }
    .finance-table thead th:nth-child(2) { text-align: right; }
    .finance-table thead th:nth-child(3) { text-align: right; }

    .finance-table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background var(--transition);
    }

    .finance-table tbody tr:hover { background: var(--surface); }

    .finance-table td {
      padding: 12px 0;
      font-size: 14px;
    }

    .finance-table td:first-child {
      text-align: left;
      font-weight: 600;
    }

    .finance-table td:nth-child(2) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .finance-table td:nth-child(3) {
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--text-muted);
    }

    .finance-table .ticker-sub {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .finance-table .change {
      font-size: 12px;
      font-weight: 500;
      display: block;
    }

    .change.up { color: var(--green); }
    .change.down { color: var(--red); }

    .section-divider td {
      padding: 20px 0 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    /* ───── Placeholder Page ───── */
    .placeholder-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      color: var(--text-muted);
      text-align: center;
      gap: 12px;
    }

    .placeholder-page .icon { font-size: 48px; }
    .placeholder-page h2 { font-size: 20px; color: var(--text); }
    .placeholder-page p { font-size: 14px; }

    /* ───── Loading / Error States ───── */
    .page-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 0;
      gap: 12px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .page-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 0;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
    }

    .page-error a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }

    .refresh-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
    }

    .refresh-bar .meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .refresh-bar button {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all var(--transition);
    }

    .refresh-bar button:hover {
      color: var(--text);
      border-color: var(--text-muted);
    }

    /* ───── Settings Panel ───── */
    #settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 98;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #settings-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    #settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(380px, 90vw);
      background: var(--bg);
      border-left: 1px solid var(--border);
      z-index: 99;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    #settings-panel.open { transform: translateX(0); }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 1;
    }

    .settings-header h2 { font-size: 18px; font-weight: 700; }

    .settings-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .settings-section h3 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
    }

    .setting-label { font-size: 14px; font-weight: 500; }
    .setting-desc { font-size: 12px; color: var(--text-muted); }

    .setting-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      outline: none;
      transition: border-color var(--transition);
      margin-top: 6px;
    }

    .setting-input:focus { border-color: var(--accent); }
    .setting-input::placeholder { color: var(--text-muted); }

    .api-key-help {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .api-key-help a { color: var(--accent); text-decoration: none; }

    /* ───── Animations ───── */
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .fade-in { animation: fadeIn 0.3s ease both; }

    /* ───── Responsive ───── */
    @media (max-width: 480px) {
      .finance-table td, .finance-table th { font-size: 13px; }
      .finance-table .ticker-sub { font-size: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>atoneplace</h1>
    <div class="header-actions">
      <select id="page-select">
        <option value="finance">FIN</option>
        <option value="nba">NBA</option>
        <option value="epl">EPL</option>
      </select>
      <button class="icon-btn" id="theme-toggle" aria-label="Toggle theme">
        <span id="theme-icon">&#9789;</span>
      </button>
      <button class="icon-btn" id="settings-btn" aria-label="Settings">
        &#9881;
      </button>
    </div>
  </header>

  <main id="page-content"></main>

  <div id="settings-overlay"></div>
  <aside id="settings-panel">
    <div class="settings-header">
      <h2>Settings</h2>
      <button class="icon-btn" id="settings-close">&times;</button>
    </div>
    <div id="settings-body"></div>
  </aside>

  <script>
    /* =====================================================
       STATE
    ===================================================== */
    const DEFAULT_STATE = {
      theme: 'dark',
      activePage: 'finance',
      apiKeys: { finnhub: '' },
      config: {
        stocks: { symbols: ['AAPL','MSFT','NVDA','GOOGL','AMZN','META','BRK.B','TSLA','AVGO','LLY'] },
        crypto: { coins: ['bitcoin'] },
      },
      profileCache: {},
      refreshMinutes: 5,
    };

    const Store = {
      _state: null,
      get() {
        if (!this._state) {
          try {
            const saved = localStorage.getItem('atoneplace');
            this._state = saved ? { ...DEFAULT_STATE, ...JSON.parse(saved) } : { ...DEFAULT_STATE };
          } catch {
            this._state = { ...DEFAULT_STATE };
          }
        }
        return this._state;
      },
      set(partial) {
        this._state = { ...this.get(), ...partial };
        localStorage.setItem('atoneplace', JSON.stringify(this._state));
      },
    };

    /* =====================================================
       HELPERS
    ===================================================== */
    const TROY_OZ_TO_GRAMS = 31.1035;

    function fmtPrice(val, currency = 'USD') {
      if (val == null) return '—';
      if (currency === 'INR') return '\u20B9' + val.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return '$' + val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtMktCap(val) {
      if (val == null) return '—';
      if (val >= 1e12) return '$' + (val / 1e12).toFixed(2) + 'T';
      if (val >= 1e9) return '$' + (val / 1e9).toFixed(2) + 'B';
      if (val >= 1e6) return '$' + (val / 1e6).toFixed(2) + 'M';
      return '$' + val.toLocaleString();
    }

    function changeHTML(pct) {
      if (pct == null) return '';
      const cls = pct >= 0 ? 'up' : 'down';
      const sign = pct >= 0 ? '+' : '';
      return `<span class="change ${cls}">${sign}${pct.toFixed(2)}%</span>`;
    }

    /* =====================================================
       API LAYER
    ===================================================== */
    const API = {
      async fetchMetals() {
        const [goldRes, silverRes, oilRes] = await Promise.all([
          fetch('https://api.gold-api.com/price/XAU').then(r => r.json()),
          fetch('https://api.gold-api.com/price/XAG').then(r => r.json()),
          fetch('https://api.gold-api.com/price/WTI').then(r => r.json()).catch(() => null),
        ]);
        return { goldUSD: goldRes.price, silverUSD: silverRes.price, oilWTI: oilRes?.price ?? null };
      },

      async fetchForex() {
        const r = await fetch('https://api.frankfurter.app/latest?from=USD&to=INR');
        const d = await r.json();
        return { INR: d.rates.INR };
      },

      async fetchIndices() {
        const PROXY = 'https://atoneplace-proxy.viveknv4.workers.dev/?url=';
        const SYMBOLS = {
          '^GSPC': 'S&P 500',
          '^VIX': 'VIX',
          'DX-Y.NYB': 'US Dollar (DXY)',
          '^TNX': '10Y Treasury',
          '^NSEI': 'Nifty 50',
        };
        const entries = Object.entries(SYMBOLS);
        const results = await Promise.all(entries.map(([sym]) => {
          const yUrl = `https://query2.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?interval=1d&range=2d`;
          return fetch(PROXY + encodeURIComponent(yUrl))
            .then(r => r.json())
            .then(d => {
              const meta = d.chart.result[0].meta;
              const closes = d.chart.result[0].indicators.quote[0].close || [];
              const prev = closes[0] ?? meta.chartPreviousClose;
              const price = meta.regularMarketPrice;
              const pct = prev ? ((price - prev) / prev) * 100 : 0;
              return { sym, price, pct };
            })
            .catch(() => null);
        }));
        const indices = {};
        results.forEach((r, i) => {
          if (!r) return;
          const [sym, label] = entries[i];
          indices[sym] = { label, price: r.price, percent_change: parseFloat(r.pct.toFixed(2)) };
        });
        return { indices };
      },

      async fetchStockQuote(symbol, key) {
        const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${key}`);
        return r.json();
      },

      async fetchStockProfile(symbol, key) {
        // Check cache (24h TTL)
        const cache = Store.get().profileCache || {};
        const cached = cache[symbol];
        if (cached && Date.now() - cached.ts < 86400000) {
          return { name: cached.name, mktCap: cached.mktCap };
        }
        const r = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${key}`);
        const d = await r.json();
        const profile = {
          name: d.name || symbol,
          mktCap: d.marketCapitalization ? d.marketCapitalization * 1e6 : null, // Finnhub returns in millions
        };
        // Save to cache
        const updated = { ...cache, [symbol]: { ...profile, ts: Date.now() } };
        Store.set({ profileCache: updated });
        return profile;
      },

      async fetchCrypto(coins) {
        const ids = coins.join(',');
        const r = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&sparkline=false`);
        return r.json();
      },
    };

    /* =====================================================
       PAGES
    ===================================================== */
    const Pages = {
      /* ───── Finance ───── */
      async finance() {
        const content = document.getElementById('page-content');
        content.innerHTML = `
          <div class="refresh-bar">
            <span class="meta" id="finance-meta">Loading...</span>
            <button onclick="App.loadPage()">Refresh</button>
          </div>
          <div class="page-loading"><div class="spinner"></div></div>`;

        try {
          const state = Store.get();
          const key = state.apiKeys.finnhub;
          const stockSymbols = state.config.stocks?.symbols || DEFAULT_STATE.config.stocks.symbols;
          const cryptoCoins = ['bitcoin'];

          // Fetch all data in parallel
          const promises = [
            API.fetchMetals().catch(() => null),
            API.fetchForex().catch(() => null),
            API.fetchCrypto(cryptoCoins).catch(() => []),
            API.fetchIndices().catch(() => null),
          ];

          // Stock data (only if Finnhub key present)
          let stockPromise;
          if (key) {
            stockPromise = (async () => {
              const results = [];
              for (const sym of stockSymbols) {
                const [quote, profile] = await Promise.all([
                  API.fetchStockQuote(sym, key).catch(() => null),
                  API.fetchStockProfile(sym, key).catch(() => ({ name: sym, mktCap: null })),
                ]);
                results.push({
                  symbol: sym,
                  name: profile.name,
                  price: quote?.c,
                  change: quote?.dp,
                  mktCap: profile.mktCap,
                });
              }
              return results;
            })();
          } else {
            stockPromise = Promise.resolve(null);
          }
          promises.push(stockPromise);

          const [metals, forex, crypto, indices, stocks] = await Promise.all(promises);

          // Build rows
          const rows = [];

          // Commodities
          const inr = forex?.INR;
          if (metals || forex) {
            rows.push({ section: 'Commodities' });
            if (metals) {
              rows.push({ name: 'Gold / oz', sub: 'XAU', price: metals.goldUSD, currency: 'USD', mktCap: null });
              rows.push({ name: 'Silver / oz', sub: 'XAG', price: metals.silverUSD, currency: 'USD', mktCap: null });
              if (metals.oilWTI) {
                rows.push({ name: 'Crude Oil', sub: 'WTI', price: metals.oilWTI, currency: 'USD', mktCap: null });
              }
              if (inr) {
                rows.push({ name: 'Gold / gm', sub: 'INR', price: (metals.goldUSD / TROY_OZ_TO_GRAMS) * inr, currency: 'INR', mktCap: null });
                rows.push({ name: 'Silver / gm', sub: 'INR', price: (metals.silverUSD / TROY_OZ_TO_GRAMS) * inr, currency: 'INR', mktCap: null });
              }
            }
          }

          // Forex
          if (inr) {
            rows.push({ section: 'Forex' });
            rows.push({ name: 'USD / INR', sub: 'FX', price: inr, currency: 'INR', mktCap: null });
          }

          // Indices (from data/indices.json — fetched by GitHub Actions)
          if (indices && indices.indices) {
            const indexData = indices.indices;
            const INDEX_ORDER = ['^GSPC', '^VIX', 'DX-Y.NYB', '^TNX', '^NSEI'];
            const indexRows = INDEX_ORDER
              .map(key => {
                const d = indexData[key];
                if (!d) return null;
                const cur = key === '^NSEI' ? 'INR' : 'USD';
                return { name: d.label, sub: key, price: d.price, pctChange: d.percent_change, currency: cur, mktCap: null };
              })
              .filter(Boolean);

            if (indexRows.length) {
              rows.push({ section: 'Indices' });
              rows.push(...indexRows);
            }
          }

          // Merge stocks + crypto sorted by market cap
          if (stocks) {
            const stockRows = stocks
              .filter(s => s.price)
              .map(s => ({
                name: s.name,
                sub: s.symbol,
                price: s.price,
                pctChange: s.change,
                currency: 'USD',
                mktCap: s.mktCap,
              }));

            const cryptoRows = (crypto || []).map(c => ({
              name: c.name,
              sub: c.symbol?.toUpperCase(),
              price: c.current_price,
              pctChange: c.price_change_percentage_24h,
              currency: 'USD',
              mktCap: c.market_cap,
            }));

            const merged = [...stockRows, ...cryptoRows].sort((a, b) => (b.mktCap || 0) - (a.mktCap || 0));

            if (merged.length) {
              rows.push({ section: 'Stocks' });
              rows.push(...merged);
            }
          } else if (key === '') {
            // No Finnhub key — show prompt + crypto that loaded
            rows.push({ section: 'Stocks' });
            rows.push({ needsKey: true, keyName: 'Finnhub', settingsLink: true });
            if (crypto && crypto.length) {
              crypto.forEach(c => rows.push({
                name: c.name, sub: c.symbol?.toUpperCase(), price: c.current_price,
                pctChange: c.price_change_percentage_24h, currency: 'USD', mktCap: c.market_cap,
              }));
            }
          }

          // Render table
          content.innerHTML = `
            <div class="refresh-bar">
              <span class="meta" id="finance-meta">Updated ${new Date().toLocaleTimeString()}</span>
              <button onclick="App.loadPage()">Refresh</button>
            </div>
            <table class="finance-table fade-in">
              <thead><tr><th>Name</th><th>Price</th><th>Mkt Cap</th></tr></thead>
              <tbody>${rows.map(r => {
                if (r.section) return `<tr class="section-divider"><td colspan="3">${r.section}</td></tr>`;
                if (r.needsKey) return `<tr><td colspan="3" style="color:var(--text-muted);font-size:13px;padding:16px 0">API key required — <a href="#" onclick="App.openSettings();return false" style="color:var(--accent);text-decoration:none">Configure in Settings</a></td></tr>`;
                return `<tr>
                  <td>${r.name}<br><span class="ticker-sub">${r.sub || ''}</span></td>
                  <td>${fmtPrice(r.price, r.currency)}${r.pctChange != null ? '<br>' + changeHTML(r.pctChange) : ''}</td>
                  <td>${fmtMktCap(r.mktCap)}</td>
                </tr>`;
              }).join('')}</tbody>
            </table>`;

        } catch (e) {
          content.innerHTML = `
            <div class="page-error">
              <span style="font-size:28px">&#9888;</span>
              <span>${e.message || 'Failed to load finance data'}</span>
              <a onclick="App.loadPage()">Retry</a>
            </div>`;
        }
      },

      /* ───── NBA (placeholder) ───── */
      nba() {
        document.getElementById('page-content').innerHTML = `
          <div class="placeholder-page fade-in">
            <div class="icon">&#127936;</div>
            <h2>NBA Scores</h2>
            <p>Coming soon — scores, standings, and more.</p>
          </div>`;
      },

      /* ───── EPL (placeholder) ───── */
      epl() {
        document.getElementById('page-content').innerHTML = `
          <div class="placeholder-page fade-in">
            <div class="icon">&#9917;</div>
            <h2>Premier League</h2>
            <p>Coming soon — fixtures, results, and table.</p>
          </div>`;
      },
    };

    /* =====================================================
       APP CONTROLLER
    ===================================================== */
    const App = {
      refreshTimer: null,

      init() {
        this.applyTheme();
        this.syncPageSelect();
        this.loadPage();
        this.bindEvents();
        this.startAutoRefresh();
        this.registerSW();
      },

      applyTheme() {
        const theme = Store.get().theme;
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('theme-icon').innerHTML = theme === 'dark' ? '&#9789;' : '&#9788;';
        document.querySelector('meta[name="theme-color"]').content = theme === 'dark' ? '#0a0a0a' : '#f5f5f5';
      },

      toggleTheme() {
        Store.set({ theme: Store.get().theme === 'dark' ? 'light' : 'dark' });
        this.applyTheme();
      },

      syncPageSelect() {
        document.getElementById('page-select').value = Store.get().activePage;
      },

      loadPage() {
        const page = Store.get().activePage;
        if (Pages[page]) Pages[page]();
      },

      switchPage(page) {
        Store.set({ activePage: page });
        this.loadPage();
      },

      startAutoRefresh() {
        if (this.refreshTimer) clearInterval(this.refreshTimer);
        const mins = Store.get().refreshMinutes || 5;
        this.refreshTimer = setInterval(() => this.loadPage(), mins * 60 * 1000);
      },

      /* ───── Settings ───── */
      openSettings() {
        this.renderSettings();
        document.getElementById('settings-overlay').classList.add('open');
        document.getElementById('settings-panel').classList.add('open');
      },

      closeSettings() {
        this.saveSettingsInputs();
        document.getElementById('settings-overlay').classList.remove('open');
        document.getElementById('settings-panel').classList.remove('open');
        this.loadPage();
        this.startAutoRefresh();
      },

      saveSettingsInputs() {
        const keyEl = document.getElementById('key-finnhub');
        if (keyEl) {
          Store.set({ apiKeys: { ...Store.get().apiKeys, finnhub: keyEl.value.trim() } });
        }

        const stocksEl = document.getElementById('cfg-stocks');
        if (stocksEl) {
          const symbols = stocksEl.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
          const config = { ...Store.get().config, stocks: { symbols } };
          Store.set({ config });
        }

        const refreshEl = document.getElementById('cfg-refresh');
        if (refreshEl) {
          Store.set({ refreshMinutes: Math.max(1, parseInt(refreshEl.value) || 5) });
        }
      },

      renderSettings() {
        const state = Store.get();
        const stocks = (state.config.stocks?.symbols || DEFAULT_STATE.config.stocks.symbols).join(', ');
        const finnhubKey = state.apiKeys.finnhub || '';

        document.getElementById('settings-body').innerHTML = `
          <div class="settings-section">
            <h3>API Keys</h3>
            <div>
              <div class="setting-label">Finnhub</div>
              <div class="setting-desc">Stocks data</div>
              <input class="setting-input" type="password" id="key-finnhub" value="${finnhubKey}" placeholder="Enter API key">
              <div class="api-key-help">Free: <a href="https://finnhub.io/register" target="_blank">finnhub.io/register</a></div>
            </div>
          </div>

          <div class="settings-section">
            <h3>Finance</h3>
            <div style="margin-bottom:16px">
              <div class="setting-label">Stock Symbols</div>
              <div class="setting-desc">Comma-separated ticker symbols</div>
              <input class="setting-input" id="cfg-stocks" value="${stocks}" placeholder="AAPL, MSFT, NVDA">
            </div>
          </div>

          <div class="settings-section">
            <h3>General</h3>
            <div class="setting-row">
              <div class="setting-label">Auto-refresh (minutes)</div>
              <input class="setting-input" type="number" min="1" max="60" id="cfg-refresh"
                value="${state.refreshMinutes || 5}" style="width:70px;text-align:center;margin:0">
            </div>
          </div>`;
      },

      /* ───── Events ───── */
      bindEvents() {
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
        document.getElementById('settings-btn').addEventListener('click', () => this.openSettings());
        document.getElementById('settings-close').addEventListener('click', () => this.closeSettings());
        document.getElementById('settings-overlay').addEventListener('click', () => this.closeSettings());
        document.getElementById('page-select').addEventListener('change', e => this.switchPage(e.target.value));
      },

      registerSW() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js').catch(() => {});
        }
      },
    };

    /* ───── Boot ───── */
    App.init();
  </script>
</body>
</html>
