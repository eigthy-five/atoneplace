<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>atoneplace</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <style>
    /* ───── Reset & Base ───── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface-hover: #1a1a1a;
      --border: #232323;
      --text: #e5e5e5;
      --text-muted: #777;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --green: #22c55e;
      --red: #ef4444;
      --radius: 12px;
      --transition: 0.2s ease;
    }

    [data-theme="light"] {
      --bg: #f5f5f5;
      --surface: #ffffff;
      --surface-hover: #fafafa;
      --border: #e5e5e5;
      --text: #1a1a1a;
      --text-muted: #666;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --green: #16a34a;
      --red: #dc2626;
    }

    html {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100dvh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* ───── Header ───── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header-actions { display: flex; align-items: center; gap: 8px; }

    .icon-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      width: 38px;
      height: 38px;
      border-radius: 10px;
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 18px;
      transition: background var(--transition);
    }

    .icon-btn:hover { background: var(--surface-hover); }

    /* ───── Page Selector ───── */
    #page-select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 32px 8px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      outline: none;
      transition: border-color var(--transition);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23777' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    #page-select:focus { border-color: var(--accent); }

    [data-theme="light"] #page-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    }

    /* ───── Main Content ───── */
    #page-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 16px 100px;
    }

    /* ───── Finance Table ───── */
    .finance-table {
      width: 100%;
      border-collapse: collapse;
    }

    .finance-table thead th {
      position: sticky;
      top: 57px;
      background: var(--bg);
      padding: 12px 0;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      z-index: 5;
    }

    .finance-table thead th:first-child { text-align: left; }
    .finance-table thead th:nth-child(2) { text-align: right; }
    .finance-table thead th:nth-child(3) { text-align: right; }

    .finance-table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background var(--transition);
    }

    .finance-table tbody tr:hover { background: var(--surface); }

    .finance-table td {
      padding: 12px 0;
      font-size: 14px;
    }

    .finance-table td:first-child {
      text-align: left;
      font-weight: 600;
    }

    .finance-table td:nth-child(2) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .finance-table td:nth-child(3) {
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--text-muted);
    }

    .finance-table .ticker-sub {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .finance-table .change {
      font-size: 12px;
      font-weight: 500;
      display: block;
    }

    .change.up { color: var(--green); }
    .change.down { color: var(--red); }

    .ah-line {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .ah-line .ah-label {
      font-weight: 600;
      font-size: 10px;
      opacity: 0.7;
    }

    .section-divider td {
      padding: 20px 0 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    /* ───── NBA Page ───── */
    .nba-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      gap: 12px;
    }

    .nba-date-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nba-date-nav button {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 14px;
      transition: background var(--transition);
    }

    .nba-date-nav button:hover { background: var(--surface-hover); }

    .nba-date-nav .date-label {
      font-size: 14px;
      font-weight: 600;
      min-width: 120px;
      text-align: center;
    }

    .tab-bar {
      display: flex;
      gap: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 3px;
    }

    .tab-bar button {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all var(--transition);
    }

    .tab-bar button.active {
      background: var(--accent);
      color: #fff;
    }

    .nba-season-select {
      appearance: none;
      -webkit-appearance: none;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 28px 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      outline: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23777' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
    }

    .game-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: border-color var(--transition);
    }

    .game-card.live {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .game-card .game-status {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      text-align: right;
      margin-bottom: 6px;
    }

    .game-card .game-status.live-status { color: var(--red); }

    .game-team {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 0;
    }

    .game-team .team-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
    }

    .game-team .team-info img {
      width: 24px;
      height: 24px;
    }

    .game-team .team-score {
      font-size: 18px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .game-team.winner .team-info { font-weight: 700; }

    .game-team .team-record {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .box-score-toggle {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 0 0;
      font-family: inherit;
      transition: color var(--transition);
    }

    .box-score-toggle:hover { color: var(--text); }

    .box-score {
      margin-top: 12px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      overflow-x: auto;
    }

    .box-score h4 {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin: 10px 0 6px;
    }

    .box-score h4:first-child { margin-top: 0; }

    .box-score table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }

    .box-score th {
      text-align: right;
      padding: 4px 6px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 10px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }

    .box-score th:first-child { text-align: left; }

    .box-score td {
      text-align: right;
      padding: 4px 6px;
      border-bottom: 1px solid var(--border);
    }

    .box-score td:first-child {
      text-align: left;
      font-weight: 500;
      white-space: nowrap;
    }

    .no-games {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .standings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 700px) {
      .standings-grid { grid-template-columns: 1fr; }
    }

    .standings-section h3 {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .standings-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }

    .standings-table th {
      text-align: right;
      padding: 8px 6px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }

    .standings-table th:first-child { text-align: left; }

    .standings-table td {
      text-align: right;
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
    }

    .standings-table td:first-child {
      text-align: left;
      font-weight: 500;
    }

    .standings-table tr:hover { background: var(--surface-hover); }

    /* ───── EPL Match Events ───── */
    .match-events {
      margin-top: 12px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    .match-event {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 4px 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .match-event .ev-time {
      min-width: 40px;
      font-weight: 600;
      color: var(--text);
      flex-shrink: 0;
    }

    .match-event.goal { color: var(--green); font-weight: 500; }
    .match-event.red-card { color: var(--red); }
    .match-event.yellow-card { color: #eab308; }

    /* ───── EPL Standings ───── */
    .epl-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }

    .epl-table th {
      text-align: right;
      padding: 8px 6px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }

    .epl-table th:first-child, .epl-table th:nth-child(2) { text-align: left; }

    .epl-table td {
      text-align: right;
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
    }

    .epl-table td:first-child { text-align: center; width: 28px; }
    .epl-table td:nth-child(2) { text-align: left; font-weight: 500; }
    .epl-table tr:hover { background: var(--surface-hover); }

    /* ───── NBA Stats ───── */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 700px) {
      .stats-grid { grid-template-columns: 1fr; }
    }

    @media (min-width: 701px) and (max-width: 1000px) {
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
    }

    .stat-card h4 {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .stat-card .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .stat-card .stat-row:last-child { border-bottom: none; }

    .stat-card .stat-rank {
      color: var(--text-muted);
      font-size: 11px;
      width: 20px;
      flex-shrink: 0;
    }

    .stat-card .stat-name {
      flex: 1;
      font-weight: 500;
    }

    .stat-card .stat-val {
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin-left: 8px;
    }

    /* ───── News ───── */
    .news-list { padding-top: 4px; }

    .news-item {
      display: block;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
      text-decoration: none;
      color: var(--text);
      transition: background var(--transition);
    }

    .news-item:hover { background: var(--surface); margin: 0 -16px; padding: 14px 16px; }

    .news-item .news-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .news-item .news-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .news-item .news-meta .dot::before { content: '\00B7'; }

    .news-item .news-time {
      margin-left: auto;
      flex-shrink: 0;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ───── Calendar ───── */
    .cal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
    }

    .cal-header .cal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .cal-header .cal-nav {
      display: flex;
      gap: 8px;
    }

    .cal-header .cal-nav button {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 14px;
      transition: background var(--transition);
    }

    .cal-header .cal-nav button:hover { background: var(--surface-hover); }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .cal-grid .cal-dow {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      padding: 8px 0;
    }

    .cal-grid .cal-day {
      aspect-ratio: 1;
      display: grid;
      place-items: center;
      font-size: 14px;
      font-weight: 500;
      border-radius: 10px;
      color: var(--text);
      transition: background var(--transition);
    }

    .cal-grid .cal-day:hover { background: var(--surface-hover); }
    .cal-grid .cal-day.empty { pointer-events: none; }
    .cal-grid .cal-day.other-month { color: var(--text-muted); opacity: 0.3; }

    .cal-grid .cal-day.today {
      background: var(--accent);
      color: #fff;
      font-weight: 700;
    }

    .cal-grid .cal-day.today:hover { background: var(--accent-hover); }

    .cal-grid .cal-day.sunday { color: var(--red); }
    .cal-grid .cal-day.sunday.other-month { color: var(--red); }
    .cal-grid .cal-day.today.sunday { color: #fff; }

    /* ───── Placeholder Page ───── */
    .placeholder-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      color: var(--text-muted);
      text-align: center;
      gap: 12px;
    }

    .placeholder-page .icon { font-size: 48px; }
    .placeholder-page h2 { font-size: 20px; color: var(--text); }
    .placeholder-page p { font-size: 14px; }

    /* ───── Loading / Error States ───── */
    .page-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 0;
      gap: 12px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .page-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 0;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
    }

    .page-error a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }

    .refresh-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
    }

    .refresh-bar .meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .refresh-bar button {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all var(--transition);
    }

    .refresh-bar button:hover {
      color: var(--text);
      border-color: var(--text-muted);
    }

    /* ───── Settings Panel ───── */
    #settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 98;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #settings-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    #settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(380px, 90vw);
      background: var(--bg);
      border-left: 1px solid var(--border);
      z-index: 99;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    #settings-panel.open { transform: translateX(0); }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 1;
    }

    .settings-header h2 { font-size: 18px; font-weight: 700; }

    .settings-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .settings-section h3 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
    }

    .setting-label { font-size: 14px; font-weight: 500; }
    .setting-desc { font-size: 12px; color: var(--text-muted); }

    .setting-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      outline: none;
      transition: border-color var(--transition);
      margin-top: 6px;
    }

    .setting-input:focus { border-color: var(--accent); }
    .setting-input::placeholder { color: var(--text-muted); }

    .api-key-help {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .api-key-help a { color: var(--accent); text-decoration: none; }

    /* ───── Animations ───── */
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .fade-in { animation: fadeIn 0.3s ease both; }

    /* ───── Responsive ───── */
    @media (max-width: 480px) {
      .finance-table td, .finance-table th { font-size: 13px; }
      .finance-table .ticker-sub { font-size: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>atoneplace</h1>
    <div class="header-actions">
      <select id="page-select">
        <option value="finance">FIN</option>
        <option value="nba">NBA</option>
        <option value="epl">EPL</option>
        <option value="news">NEWS</option>
        <option value="cal">CAL</option>
      </select>
      <button class="icon-btn" id="theme-toggle" aria-label="Toggle theme">
        <span id="theme-icon">&#9789;</span>
      </button>
      <button class="icon-btn" id="settings-btn" aria-label="Settings">
        &#9881;
      </button>
    </div>
  </header>

  <main id="page-content"></main>

  <div id="settings-overlay"></div>
  <aside id="settings-panel">
    <div class="settings-header">
      <h2>Settings</h2>
      <button class="icon-btn" id="settings-close">&times;</button>
    </div>
    <div id="settings-body"></div>
  </aside>

  <script>
    /* =====================================================
       STATE
    ===================================================== */
    const DEFAULT_STATE = {
      theme: 'dark',
      activePage: 'finance',
      apiKeys: {},
      config: {
        stocks: { symbols: ['AAPL','MSFT','NVDA','GOOGL','AMZN','META','BRK.B','TSLA','AVGO','LLY'] },
        crypto: { coins: ['bitcoin'] },
      },
      profileCache: {},
      refreshMinutes: 5,
    };

    const Store = {
      _state: null,
      get() {
        if (!this._state) {
          try {
            const saved = localStorage.getItem('atoneplace');
            this._state = saved ? { ...DEFAULT_STATE, ...JSON.parse(saved) } : { ...DEFAULT_STATE };
          } catch {
            this._state = { ...DEFAULT_STATE };
          }
        }
        return this._state;
      },
      set(partial) {
        this._state = { ...this.get(), ...partial };
        localStorage.setItem('atoneplace', JSON.stringify(this._state));
      },
    };

    /* =====================================================
       HELPERS
    ===================================================== */
    const TROY_OZ_TO_GRAMS = 31.1035;

    function fmtPrice(val, currency = 'USD') {
      if (val == null) return '—';
      if (currency === 'INR') return '\u20B9' + val.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return '$' + val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtMktCap(val) {
      if (val == null) return '—';
      if (val >= 1e12) return '$' + (val / 1e12).toFixed(2) + 'T';
      if (val >= 1e9) return '$' + (val / 1e9).toFixed(2) + 'B';
      if (val >= 1e6) return '$' + (val / 1e6).toFixed(2) + 'M';
      return '$' + val.toLocaleString();
    }

    function changeHTML(pct) {
      if (pct == null) return '';
      const cls = pct >= 0 ? 'up' : 'down';
      const sign = pct >= 0 ? '+' : '';
      return `<span class="change ${cls}">${sign}${pct.toFixed(2)}%</span>`;
    }

    function timeAgo(ts) {
      const sec = Math.floor((Date.now() - (typeof ts === 'number' ? ts * 1000 : new Date(ts).getTime())) / 1000);
      if (sec < 60) return 'now';
      if (sec < 3600) return Math.floor(sec / 60) + 'm ago';
      if (sec < 86400) return Math.floor(sec / 3600) + 'h ago';
      return Math.floor(sec / 86400) + 'd ago';
    }

    function extractDomain(url) {
      try { return new URL(url).hostname.replace('www.', ''); } catch { return ''; }
    }

    /* =====================================================
       API LAYER
    ===================================================== */
    const API = {
      async fetchMetals() {
        const [goldRes, silverRes, oilRes] = await Promise.all([
          fetch('https://api.gold-api.com/price/XAU').then(r => r.json()),
          fetch('https://api.gold-api.com/price/XAG').then(r => r.json()),
          fetch('https://api.gold-api.com/price/WTI').then(r => r.json()).catch(() => null),
        ]);
        return { goldUSD: goldRes.price, silverUSD: silverRes.price, oilWTI: oilRes?.price ?? null };
      },

      async fetchForex() {
        const r = await fetch('https://api.frankfurter.app/latest?from=USD&to=INR');
        const d = await r.json();
        return { INR: d.rates.INR };
      },

      async fetchIndices() {
        const PROXY = 'https://atoneplace-proxy.viveknv4.workers.dev/?url=';
        const SYMBOLS = {
          '^GSPC': 'S&P 500',
          '^VIX': 'VIX',
          'DX-Y.NYB': 'US Dollar (DXY)',
          '^TNX': '10Y Treasury',
          '^NSEI': 'Nifty 50',
        };
        const entries = Object.entries(SYMBOLS);
        const results = await Promise.all(entries.map(([sym]) => {
          const yUrl = `https://query2.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?interval=1d&range=2d`;
          return fetch(PROXY + encodeURIComponent(yUrl))
            .then(r => r.json())
            .then(d => {
              const meta = d.chart.result[0].meta;
              const closes = d.chart.result[0].indicators.quote[0].close || [];
              const prev = closes[0] ?? meta.chartPreviousClose;
              const price = meta.regularMarketPrice;
              const pct = prev ? ((price - prev) / prev) * 100 : 0;
              return { sym, price, pct };
            })
            .catch(() => null);
        }));
        const indices = {};
        results.forEach((r, i) => {
          if (!r) return;
          const [sym, label] = entries[i];
          indices[sym] = { label, price: r.price, percent_change: parseFloat(r.pct.toFixed(2)) };
        });
        return { indices };
      },

      async fetchStocks(symbols) {
        const PROXY = 'https://atoneplace-proxy.viveknv4.workers.dev';
        const r = await fetch(`${PROXY}/quote?symbols=${encodeURIComponent(symbols.join(','))}`);
        return r.json();
      },

      async fetchNBAScoreboard(date) {
        const url = `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard${date ? '?dates=' + date : ''}`;
        const r = await fetch(url);
        return r.json();
      },

      async fetchNBAStandings(season = 2026) {
        const r = await fetch(`https://site.api.espn.com/apis/v2/sports/basketball/nba/standings?season=${season}`);
        return r.json();
      },

      async fetchNBALeaders(season = 2026) {
        const r = await fetch(`https://sports.core.api.espn.com/v2/sports/basketball/leagues/nba/seasons/${season}/types/2/leaders?limit=10`);
        return r.json();
      },

      async fetchNBAAthlete(url) {
        const r = await fetch(url);
        const d = await r.json();
        return { name: d.shortName || d.displayName, pos: d.position?.abbreviation || '' };
      },

      async fetchHNTopStories(limit = 20) {
        const ids = await fetch('https://hacker-news.firebaseio.com/v0/topstories.json').then(r => r.json());
        const items = await Promise.all(
          ids.slice(0, limit).map(id =>
            fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(r => r.json()).catch(() => null)
          )
        );
        return items.filter(Boolean);
      },

      async fetchFinanceNews() {
        const feeds = [
          'https://feeds.finance.yahoo.com/rss/2.0/headline?s=AAPL,MSFT&region=US&lang=en-US',
          'https://www.cnbc.com/id/100003114/device/rss/rss.html',
        ];
        const results = await Promise.all(feeds.map(url =>
          fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`)
            .then(r => r.json())
            .then(d => (d.items || []).map(item => ({
              title: item.title,
              link: item.link,
              time: item.pubDate,
              source: extractDomain(item.link),
            })))
            .catch(() => [])
        ));
        return results.flat().sort((a, b) => new Date(b.time) - new Date(a.time));
      },

      async fetchEPLScoreboard(date) {
        const url = `https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/scoreboard${date ? '?dates=' + date : ''}`;
        const r = await fetch(url);
        return r.json();
      },

      async fetchEPLStandings(season = 2025) {
        const r = await fetch(`https://site.api.espn.com/apis/v2/sports/soccer/eng.1/standings?season=${season}`);
        return r.json();
      },

      async fetchEPLSummary(eventId) {
        const r = await fetch(`https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/summary?event=${eventId}`);
        return r.json();
      },

      async fetchEPLLeaders(season = 2025) {
        const r = await fetch(`https://sports.core.api.espn.com/v2/sports/soccer/leagues/eng.1/seasons/${season}/types/1/leaders?limit=10`);
        return r.json();
      },

      async fetchEPLAthlete(url) {
        const r = await fetch(url);
        const d = await r.json();
        return { name: d.shortName || d.displayName, pos: d.position?.abbreviation || '' };
      },

      async fetchNBABoxScore(eventId) {
        const r = await fetch(`https://site.api.espn.com/apis/site/v2/sports/basketball/nba/summary?event=${eventId}`);
        return r.json();
      },

      async fetchCrypto(coins) {
        const ids = coins.join(',');
        const r = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&sparkline=false`);
        return r.json();
      },
    };

    /* =====================================================
       PAGES
    ===================================================== */
    const Pages = {
      /* ───── Finance ───── */
      async finance() {
        const content = document.getElementById('page-content');
        content.innerHTML = `
          <div class="refresh-bar">
            <span class="meta" id="finance-meta">Loading...</span>
            <button onclick="App.loadPage()">Refresh</button>
          </div>
          <div class="page-loading"><div class="spinner"></div></div>`;

        try {
          const state = Store.get();
          const stockSymbols = state.config.stocks?.symbols || DEFAULT_STATE.config.stocks.symbols;

          // Fetch all data in parallel
          const [metals, forex, crypto, indices, stocks] = await Promise.all([
            API.fetchMetals().catch(() => null),
            API.fetchForex().catch(() => null),
            API.fetchCrypto(['bitcoin']).catch(() => []),
            API.fetchIndices().catch(() => null),
            API.fetchStocks(stockSymbols).catch(() => []),
          ]);

          // Build rows
          const rows = [];

          // Commodities
          const inr = forex?.INR;
          if (metals || forex) {
            rows.push({ section: 'Commodities' });
            if (metals) {
              rows.push({ name: 'Gold / oz', sub: 'XAU', price: metals.goldUSD, currency: 'USD', mktCap: null });
              rows.push({ name: 'Silver / oz', sub: 'XAG', price: metals.silverUSD, currency: 'USD', mktCap: null });
              if (metals.oilWTI) {
                rows.push({ name: 'Crude Oil', sub: 'WTI', price: metals.oilWTI, currency: 'USD', mktCap: null });
              }
              if (inr) {
                rows.push({ name: 'Gold / gm', sub: 'INR', price: (metals.goldUSD / TROY_OZ_TO_GRAMS) * inr, currency: 'INR', mktCap: null });
                rows.push({ name: 'Silver / gm', sub: 'INR', price: (metals.silverUSD / TROY_OZ_TO_GRAMS) * inr, currency: 'INR', mktCap: null });
              }
            }
          }

          // Forex
          if (inr) {
            rows.push({ section: 'Forex' });
            rows.push({ name: 'USD / INR', sub: 'FX', price: inr, currency: 'INR', mktCap: null });
          }

          // Indices (from data/indices.json — fetched by GitHub Actions)
          if (indices && indices.indices) {
            const indexData = indices.indices;
            const INDEX_ORDER = ['^GSPC', '^VIX', 'DX-Y.NYB', '^TNX', '^NSEI'];
            const indexRows = INDEX_ORDER
              .map(key => {
                const d = indexData[key];
                if (!d) return null;
                const cur = key === '^NSEI' ? 'INR' : 'USD';
                return { name: d.label, sub: key, price: d.price, pctChange: d.percent_change, currency: cur, mktCap: null };
              })
              .filter(Boolean);

            if (indexRows.length) {
              rows.push({ section: 'Indices' });
              rows.push(...indexRows);
            }
          }

          // Merge stocks + crypto sorted by market cap
          {
            const stockRows = (stocks || [])
              .filter(s => s.price)
              .map(s => ({
                name: s.name,
                sub: s.symbol,
                price: s.price,
                pctChange: s.change,
                currency: 'USD',
                mktCap: s.mktCap,
                marketState: s.marketState,
                postPrice: s.postPrice,
                postChange: s.postChange,
                prePrice: s.prePrice,
                preChange: s.preChange,
              }));

            const cryptoRows = (crypto || []).map(c => ({
              name: c.name,
              sub: c.symbol?.toUpperCase(),
              price: c.current_price,
              pctChange: c.price_change_percentage_24h,
              currency: 'USD',
              mktCap: c.market_cap,
            }));

            const merged = [...stockRows, ...cryptoRows].sort((a, b) => (b.mktCap || 0) - (a.mktCap || 0));

            if (merged.length) {
              rows.push({ section: 'Stocks' });
              rows.push(...merged);
            }
          }

          // Render table
          content.innerHTML = `
            <div class="refresh-bar">
              <span class="meta" id="finance-meta">Updated ${new Date().toLocaleTimeString()}</span>
              <button onclick="App.loadPage()">Refresh</button>
            </div>
            <table class="finance-table fade-in">
              <thead><tr><th>Name</th><th>Price</th><th>Mkt Cap</th></tr></thead>
              <tbody>${rows.map(r => {
                if (r.section) return `<tr class="section-divider"><td colspan="3">${r.section}</td></tr>`;
                if (r.needsKey) return `<tr><td colspan="3" style="color:var(--text-muted);font-size:13px;padding:16px 0">API key required — <a href="#" onclick="App.openSettings();return false" style="color:var(--accent);text-decoration:none">Configure in Settings</a></td></tr>`;
                let ahHTML = '';
                if (r.postPrice && r.marketState && r.marketState !== 'REGULAR') {
                  const cls = (r.postChange || 0) >= 0 ? 'up' : 'down';
                  const sign = (r.postChange || 0) >= 0 ? '+' : '';
                  ahHTML = `<div class="ah-line"><span class="ah-label">AH</span> ${fmtPrice(r.postPrice, r.currency)} <span class="change ${cls}">${sign}${(r.postChange || 0).toFixed(2)}%</span></div>`;
                } else if (r.prePrice && r.marketState === 'PRE') {
                  const cls = (r.preChange || 0) >= 0 ? 'up' : 'down';
                  const sign = (r.preChange || 0) >= 0 ? '+' : '';
                  ahHTML = `<div class="ah-line"><span class="ah-label">PM</span> ${fmtPrice(r.prePrice, r.currency)} <span class="change ${cls}">${sign}${(r.preChange || 0).toFixed(2)}%</span></div>`;
                }
                return `<tr>
                  <td>${r.name}<br><span class="ticker-sub">${r.sub || ''}</span></td>
                  <td>${fmtPrice(r.price, r.currency)}${r.pctChange != null ? '<br>' + changeHTML(r.pctChange) : ''}${ahHTML}</td>
                  <td>${fmtMktCap(r.mktCap)}</td>
                </tr>`;
              }).join('')}</tbody>
            </table>`;

        } catch (e) {
          content.innerHTML = `
            <div class="page-error">
              <span style="font-size:28px">&#9888;</span>
              <span>${e.message || 'Failed to load finance data'}</span>
              <a onclick="App.loadPage()">Retry</a>
            </div>`;
        }
      },

      /* ───── NBA ───── */
      _nbaDate: null,
      _nbaTab: 'scores',
      _nbaSeason: 2026,
      _nbaBoxCache: {},

      async nba() {
        const content = document.getElementById('page-content');
        if (!this._nbaDate) this._nbaDate = new Date();
        const tab = this._nbaTab;

        const dateStr = this._nbaDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const yyyymmdd = this._nbaDate.getFullYear().toString() +
          String(this._nbaDate.getMonth() + 1).padStart(2, '0') +
          String(this._nbaDate.getDate()).padStart(2, '0');

        content.innerHTML = `
          <div class="nba-nav">
            ${tab === 'scores' ? `<div class="nba-date-nav">
              <button onclick="Pages._nbaShiftDate(-1)">&lsaquo;</button>
              <span class="date-label">${dateStr}</span>
              <button onclick="Pages._nbaShiftDate(1)">&rsaquo;</button>
            </div>` : `<select id="nba-season-select" class="nba-season-select" onchange="Pages._nbaSeason=parseInt(this.value);Pages.nba()">
              ${[2026,2025,2024,2023,2022].map(y => `<option value="${y}" ${y === (this._nbaSeason || 2026) ? 'selected' : ''}>${y-1}-${String(y).slice(2)}</option>`).join('')}
            </select>`}
            <div class="tab-bar">
              <button class="${tab === 'scores' ? 'active' : ''}" onclick="Pages._nbaTab='scores';Pages.nba()">Scores</button>
              <button class="${tab === 'standings' ? 'active' : ''}" onclick="Pages._nbaTab='standings';Pages.nba()">Standings</button>
              <button class="${tab === 'stats' ? 'active' : ''}" onclick="Pages._nbaTab='stats';Pages.nba()">Stats</button>
            </div>
          </div>
          <div id="nba-content"><div class="page-loading"><div class="spinner"></div></div></div>`;

        try {
          if (tab === 'scores') {
            await this._nbaRenderScores(yyyymmdd);
          } else if (tab === 'standings') {
            await this._nbaRenderStandings();
          } else if (tab === 'stats') {
            await this._nbaRenderStats();
          }
        } catch (e) {
          document.getElementById('nba-content').innerHTML = `
            <div class="page-error">
              <span style="font-size:28px">&#9888;</span>
              <span>${e.message || 'Failed to load NBA data'}</span>
              <a onclick="Pages.nba()">Retry</a>
            </div>`;
        }
      },

      _nbaShiftDate(delta) {
        this._nbaDate.setDate(this._nbaDate.getDate() + delta);
        this.nba();
      },

      async _nbaRenderScores(date) {
        const data = await API.fetchNBAScoreboard(date);
        const events = data.events || [];
        const container = document.getElementById('nba-content');

        if (!events.length) {
          container.innerHTML = '<div class="no-games fade-in">No games scheduled</div>';
          return;
        }

        container.innerHTML = '<div class="fade-in">' + events.map(ev => {
          const comp = ev.competitions[0];
          const status = comp.status;
          const isLive = status.type.state === 'in';
          const isFinal = status.type.state === 'post';
          const isPre = status.type.state === 'pre';

          let statusText = '';
          if (isLive) {
            statusText = `Q${status.period} ${status.displayClock}`;
          } else if (isFinal) {
            statusText = status.type.detail || 'Final';
          } else {
            statusText = new Date(ev.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          }

          const away = comp.competitors.find(c => c.homeAway === 'away');
          const home = comp.competitors.find(c => c.homeAway === 'home');

          const awayWin = isFinal && parseInt(away.score) > parseInt(home.score);
          const homeWin = isFinal && parseInt(home.score) > parseInt(away.score);

          const teamRow = (team, isWinner) => {
            const logo = team.team.logo || '';
            const record = team.records?.[0]?.summary || '';
            return `<div class="game-team ${isWinner ? 'winner' : ''}">
              <div class="team-info">
                ${logo ? `<img src="${logo}" alt="">` : ''}
                <span>${team.team.abbreviation} <span class="team-record">${record}</span></span>
              </div>
              <div class="team-score">${isPre ? '' : team.score}</div>
            </div>`;
          };

          return `<div class="game-card ${isLive ? 'live' : ''}" id="game-${ev.id}">
            <div class="game-status ${isLive ? 'live-status' : ''}">${statusText}</div>
            ${teamRow(away, awayWin)}
            ${teamRow(home, homeWin)}
            ${isFinal ? `<button class="box-score-toggle" onclick="Pages._nbaToggleBox('${ev.id}')">&#9656; Box Score</button><div id="box-${ev.id}" style="display:none"></div>` : ''}
          </div>`;
        }).join('') + '</div>';
      },

      async _nbaToggleBox(eventId) {
        const el = document.getElementById('box-' + eventId);
        if (!el) return;

        if (el.style.display !== 'none') {
          el.style.display = 'none';
          return;
        }

        el.style.display = 'block';

        if (el.innerHTML) return; // already loaded

        el.innerHTML = '<div class="page-loading" style="padding:12px 0"><div class="spinner"></div></div>';

        try {
          const data = this._nbaBoxCache[eventId] || await API.fetchNBABoxScore(eventId);
          this._nbaBoxCache[eventId] = data;

          const boxscore = data.boxscore;
          if (!boxscore || !boxscore.players) {
            el.innerHTML = '<div style="padding:8px 0;color:var(--text-muted);font-size:12px">Box score not available</div>';
            return;
          }

          const COLS = ['MIN', 'PTS', 'REB', 'AST', 'FG', '+/-'];
          const COL_KEYS = ['minutes', 'points', 'totalRebounds', 'assists', 'fieldGoalsMade-fieldGoalsAttempted', 'plusMinus'];

          let html = '<div class="box-score">';
          boxscore.players.forEach(teamData => {
            const teamName = teamData.team.abbreviation;
            html += `<h4>${teamName}</h4>`;
            html += `<table><thead><tr><th>Player</th>${COLS.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>`;

            const labels = teamData.statistics[0]?.labels || [];

            teamData.statistics[0]?.athletes?.forEach(p => {
              const stats = p.stats || [];
              if (!stats.length) return;
              const name = p.athlete?.shortName || p.athlete?.displayName || '';

              // Map stats by label index
              const minIdx = labels.indexOf('MIN');
              const ptsIdx = labels.indexOf('PTS');
              const rebIdx = labels.indexOf('REB');
              const astIdx = labels.indexOf('AST');
              const fgIdx = labels.indexOf('FG');
              const pmIdx = labels.indexOf('+/-');

              const min = stats[minIdx] || '0';
              const pts = stats[ptsIdx] || '0';
              const reb = stats[rebIdx] || '0';
              const ast = stats[astIdx] || '0';
              const fg = stats[fgIdx] || '-';
              const pm = stats[pmIdx] || '0';

              if (min === '0' && pts === '0') return; // skip DNPs

              html += `<tr><td>${name}</td><td>${min}</td><td>${pts}</td><td>${reb}</td><td>${ast}</td><td>${fg}</td><td>${pm}</td></tr>`;
            });

            html += '</tbody></table>';
          });
          html += '</div>';
          el.innerHTML = html;
        } catch {
          el.innerHTML = '<div style="padding:8px 0;color:var(--text-muted);font-size:12px">Failed to load box score</div>';
        }
      },

      async _nbaRenderStandings() {
        const data = await API.fetchNBAStandings(this._nbaSeason || 2026);
        const container = document.getElementById('nba-content');
        const children = data.children || [];

        if (!children.length) {
          container.innerHTML = '<div class="no-games fade-in">Standings not available</div>';
          return;
        }

        let html = '<div class="standings-grid fade-in">';
        children.forEach(conf => {
          const confName = conf.name || 'Conference';
          const entries = conf.standings?.entries || [];

          entries.sort((a, b) => {
            const aW = a.stats?.find(s => s.name === 'wins')?.value || 0;
            const bW = b.stats?.find(s => s.name === 'wins')?.value || 0;
            return bW - aW;
          });

          html += `<div class="standings-section"><h3>${confName}</h3>`;
          html += `<table class="standings-table"><thead><tr><th>#</th><th style="text-align:left">Team</th><th>W</th><th>L</th><th>PCT</th><th>GB</th></tr></thead><tbody>`;

          entries.forEach((entry, i) => {
            const team = entry.team?.abbreviation || entry.team?.shortDisplayName || '?';
            const stats = entry.stats || [];
            const wins = stats.find(s => s.name === 'wins')?.displayValue || '0';
            const losses = stats.find(s => s.name === 'losses')?.displayValue || '0';
            const pct = stats.find(s => s.name === 'winPercent')?.displayValue || '.000';
            const gb = stats.find(s => s.name === 'gamesBehind')?.displayValue || '-';

            html += `<tr><td>${i + 1}</td><td style="text-align:left">${team}</td><td>${wins}</td><td>${losses}</td><td>${pct}</td><td>${gb}</td></tr>`;
          });

          html += '</tbody></table></div>';
        });
        html += '</div>';
        container.innerHTML = html;
      },

      _nbaAthleteCache: {},

      async _nbaRenderStats() {
        const season = this._nbaSeason || 2026;
        const data = await API.fetchNBALeaders(season);
        const container = document.getElementById('nba-content');
        const categories = data.categories || [];

        if (!categories.length) {
          container.innerHTML = '<div class="no-games fade-in">Stats not available</div>';
          return;
        }

        // Collect all unique athlete refs
        const athleteRefs = new Map();
        categories.forEach(cat => {
          (cat.leaders || []).forEach(leader => {
            const ref = leader.athlete?.$ref;
            if (ref && !this._nbaAthleteCache[ref]) athleteRefs.set(ref, null);
          });
        });

        // Batch resolve athlete names
        if (athleteRefs.size) {
          const entries = [...athleteRefs.keys()];
          const results = await Promise.all(entries.map(url => API.fetchNBAAthlete(url).catch(() => ({ name: '?', pos: '' }))));
          entries.forEach((url, i) => { this._nbaAthleteCache[url] = results[i]; });
        }

        const SHOW_ORDER = [
          'pointsPerGame', 'reboundsPerGame', 'assistsPerGame',
          'stealsPerGame', 'blocksPerGame', 'PER',
          'fieldGoalPercentage', 'FreeThrowPct', '3PointPct',
        ];
        const SHORT = {
          'pointsPerGame': 'PPG', 'assistsPerGame': 'APG', 'reboundsPerGame': 'RPG',
          'stealsPerGame': 'SPG', 'blocksPerGame': 'BPG', 'PER': 'PER',
          'fieldGoalPercentage': 'FG%', 'FreeThrowPct': 'FT%', '3PointPct': '3P%',
        };

        const catMap = {};
        categories.forEach(cat => { catMap[cat.name] = cat; });

        let html = '<div class="stats-grid fade-in">';
        SHOW_ORDER.forEach(key => {
          const cat = catMap[key];
          if (!cat) return;
          const label = SHORT[key] || cat.displayName || key;
          const leaders = cat.leaders || [];
          if (!leaders.length) return;

          html += `<div class="stat-card"><h4>${label}</h4>`;
          leaders.slice(0, 10).forEach((leader, i) => {
            const ref = leader.athlete?.$ref;
            const athlete = this._nbaAthleteCache[ref] || { name: '?', pos: '' };
            html += `<div class="stat-row">
              <span class="stat-rank">${i + 1}</span>
              <span class="stat-name">${athlete.name}</span>
              <span class="stat-val">${leader.displayValue}</span>
            </div>`;
          });
          html += '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
      },

      /* ───── EPL ───── */
      _eplDate: null,
      _eplTab: 'scores',
      _eplSeason: 2025,
      _eplEventCache: {},
      _eplAthleteCache: {},

      async epl() {
        const content = document.getElementById('page-content');
        if (!this._eplDate) this._eplDate = new Date();
        const tab = this._eplTab;

        const dateStr = this._eplDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const yyyymmdd = this._eplDate.getFullYear().toString() +
          String(this._eplDate.getMonth() + 1).padStart(2, '0') +
          String(this._eplDate.getDate()).padStart(2, '0');

        content.innerHTML = `
          <div class="nba-nav">
            ${tab === 'scores' ? `<div class="nba-date-nav">
              <button onclick="Pages._eplShiftDate(-1)">&lsaquo;</button>
              <span class="date-label">${dateStr}</span>
              <button onclick="Pages._eplShiftDate(1)">&rsaquo;</button>
            </div>` : `<select class="nba-season-select" onchange="Pages._eplSeason=parseInt(this.value);Pages.epl()">
              ${[2025,2024,2023,2022,2021].map(y => `<option value="${y}" ${y === (this._eplSeason || 2025) ? 'selected' : ''}>${y}-${String(y+1).slice(2)}</option>`).join('')}
            </select>`}
            <div class="tab-bar">
              <button class="${tab === 'scores' ? 'active' : ''}" onclick="Pages._eplTab='scores';Pages.epl()">Scores</button>
              <button class="${tab === 'standings' ? 'active' : ''}" onclick="Pages._eplTab='standings';Pages.epl()">Table</button>
              <button class="${tab === 'stats' ? 'active' : ''}" onclick="Pages._eplTab='stats';Pages.epl()">Stats</button>
            </div>
          </div>
          <div id="epl-content"><div class="page-loading"><div class="spinner"></div></div></div>`;

        try {
          if (tab === 'scores') await this._eplRenderScores(yyyymmdd);
          else if (tab === 'standings') await this._eplRenderStandings();
          else if (tab === 'stats') await this._eplRenderStats();
        } catch (e) {
          document.getElementById('epl-content').innerHTML = `
            <div class="page-error">
              <span style="font-size:28px">&#9888;</span>
              <span>${e.message || 'Failed to load EPL data'}</span>
              <a onclick="Pages.epl()">Retry</a>
            </div>`;
        }
      },

      _eplShiftDate(delta) {
        this._eplDate.setDate(this._eplDate.getDate() + delta);
        this.epl();
      },

      async _eplRenderScores(date) {
        const data = await API.fetchEPLScoreboard(date);
        const events = data.events || [];
        const container = document.getElementById('epl-content');

        if (!events.length) {
          container.innerHTML = '<div class="no-games fade-in">No matches scheduled</div>';
          return;
        }

        container.innerHTML = '<div class="fade-in">' + events.map(ev => {
          const comp = ev.competitions[0];
          const status = comp.status;
          const isLive = status.type.state === 'in';
          const isFinal = status.type.state === 'post';
          const isPre = status.type.state === 'pre';

          let statusText = '';
          if (isLive) {
            statusText = status.displayClock || 'LIVE';
          } else if (isFinal) {
            statusText = status.type.detail || 'FT';
          } else {
            statusText = new Date(ev.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          }

          const home = comp.competitors.find(c => c.homeAway === 'home');
          const away = comp.competitors.find(c => c.homeAway === 'away');

          const homeWin = isFinal && parseInt(home.score) > parseInt(away.score);
          const awayWin = isFinal && parseInt(away.score) > parseInt(home.score);

          const teamRow = (team, isWinner) => {
            const logo = team.team.logo || '';
            const record = team.records?.[0]?.summary || '';
            return `<div class="game-team ${isWinner ? 'winner' : ''}">
              <div class="team-info">
                ${logo ? `<img src="${logo}" alt="">` : ''}
                <span>${team.team.abbreviation} <span class="team-record">${record}</span></span>
              </div>
              <div class="team-score">${isPre ? '' : team.score}</div>
            </div>`;
          };

          return `<div class="game-card ${isLive ? 'live' : ''}" id="epl-game-${ev.id}">
            <div class="game-status ${isLive ? 'live-status' : ''}">${statusText}</div>
            ${teamRow(home, homeWin)}
            ${teamRow(away, awayWin)}
            ${isFinal ? `<button class="box-score-toggle" onclick="Pages._eplToggleEvents('${ev.id}')">&#9656; Match Events</button><div id="epl-ev-${ev.id}" style="display:none"></div>` : ''}
          </div>`;
        }).join('') + '</div>';
      },

      async _eplToggleEvents(eventId) {
        const el = document.getElementById('epl-ev-' + eventId);
        if (!el) return;

        if (el.style.display !== 'none') {
          el.style.display = 'none';
          return;
        }

        el.style.display = 'block';
        if (el.innerHTML) return;

        el.innerHTML = '<div class="page-loading" style="padding:12px 0"><div class="spinner"></div></div>';

        try {
          const data = this._eplEventCache[eventId] || await API.fetchEPLSummary(eventId);
          this._eplEventCache[eventId] = data;

          const keyEvents = (data.keyEvents || []).filter(e => {
            const t = e.type?.text || '';
            return t === 'Goal' || t === 'Yellow Card' || t === 'Red Card';
          });

          if (!keyEvents.length) {
            el.innerHTML = '<div style="padding:8px 0;color:var(--text-muted);font-size:12px">No key events</div>';
            return;
          }

          let html = '<div class="match-events">';
          keyEvents.forEach(e => {
            const t = e.type?.text || '';
            const time = e.clock?.displayValue || '';
            const text = e.text || '';
            let cls = '';
            let icon = '';
            if (t === 'Goal') { cls = 'goal'; icon = '\u26BD'; }
            else if (t === 'Yellow Card') { cls = 'yellow-card'; icon = '\uD83D\uDFE8'; }
            else if (t === 'Red Card') { cls = 'red-card'; icon = '\uD83D\uDFE5'; }
            html += `<div class="match-event ${cls}"><span class="ev-time">${time}</span><span>${icon} ${text}</span></div>`;
          });
          html += '</div>';
          el.innerHTML = html;
        } catch {
          el.innerHTML = '<div style="padding:8px 0;color:var(--text-muted);font-size:12px">Failed to load events</div>';
        }
      },

      async _eplRenderStandings() {
        const season = this._eplSeason || 2025;
        const data = await API.fetchEPLStandings(season);
        const container = document.getElementById('epl-content');
        const entries = data.children?.[0]?.standings?.entries || [];

        if (!entries.length) {
          container.innerHTML = '<div class="no-games fade-in">Standings not available</div>';
          return;
        }

        entries.sort((a, b) => {
          const aR = a.stats?.find(s => s.name === 'rank')?.value || 99;
          const bR = b.stats?.find(s => s.name === 'rank')?.value || 99;
          return aR - bR;
        });

        let html = '<div class="fade-in"><table class="epl-table"><thead><tr><th>#</th><th>Team</th><th>GP</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead><tbody>';
        entries.forEach((entry, i) => {
          const team = entry.team?.abbreviation || entry.team?.shortDisplayName || '?';
          const stats = entry.stats || [];
          const s = name => stats.find(s => s.name === name)?.displayValue || '0';
          html += `<tr><td>${i + 1}</td><td>${team}</td><td>${s('gamesPlayed')}</td><td>${s('wins')}</td><td>${s('ties')}</td><td>${s('losses')}</td><td>${s('pointDifferential')}</td><td><strong>${s('points')}</strong></td></tr>`;
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
      },

      async _eplRenderStats() {
        const season = this._eplSeason || 2025;
        const data = await API.fetchEPLLeaders(season);
        const container = document.getElementById('epl-content');
        const categories = data.categories || [];

        if (!categories.length) {
          container.innerHTML = '<div class="no-games fade-in">Stats not available</div>';
          return;
        }

        // Collect athlete refs
        const athleteRefs = new Map();
        categories.forEach(cat => {
          (cat.leaders || []).forEach(leader => {
            const ref = leader.athlete?.$ref;
            if (ref && !this._eplAthleteCache[ref]) athleteRefs.set(ref, null);
          });
        });

        if (athleteRefs.size) {
          const entries = [...athleteRefs.keys()];
          const results = await Promise.all(entries.map(url => API.fetchEPLAthlete(url).catch(() => ({ name: '?', pos: '' }))));
          entries.forEach((url, i) => { this._eplAthleteCache[url] = results[i]; });
        }

        const SHOW_ORDER = ['goals', 'assists', 'shotsOnTarget', 'yellowCards', 'redCards', 'foulsCommitted'];
        const SHORT = {
          'goals': 'Goals', 'assists': 'Assists', 'shotsOnTarget': 'Shots on Target',
          'yellowCards': 'Yellow Cards', 'redCards': 'Red Cards', 'foulsCommitted': 'Fouls',
        };

        const catMap = {};
        categories.forEach(cat => { catMap[cat.name] = cat; });

        let html = '<div class="stats-grid fade-in">';
        SHOW_ORDER.forEach(key => {
          const cat = catMap[key];
          if (!cat) return;
          const label = SHORT[key] || cat.displayName || key;
          const leaders = cat.leaders || [];
          if (!leaders.length) return;

          html += `<div class="stat-card"><h4>${label}</h4>`;
          leaders.slice(0, 10).forEach((leader, i) => {
            const ref = leader.athlete?.$ref;
            const athlete = this._eplAthleteCache[ref] || { name: '?', pos: '' };
            html += `<div class="stat-row">
              <span class="stat-rank">${i + 1}</span>
              <span class="stat-name">${athlete.name}</span>
              <span class="stat-val">${leader.displayValue}</span>
            </div>`;
          });
          html += '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
      },

      /* ───── News ───── */
      _newsTab: 'tech',

      async news() {
        const content = document.getElementById('page-content');
        const tab = this._newsTab;

        content.innerHTML = `
          <div class="nba-nav">
            <div></div>
            <div class="tab-bar">
              <button class="${tab === 'tech' ? 'active' : ''}" onclick="Pages._newsTab='tech';Pages.news()">Tech</button>
              <button class="${tab === 'finance' ? 'active' : ''}" onclick="Pages._newsTab='finance';Pages.news()">Finance</button>
            </div>
          </div>
          <div id="news-content"><div class="page-loading"><div class="spinner"></div></div></div>`;

        try {
          if (tab === 'tech') await this._newsRenderTech();
          else await this._newsRenderFinance();
        } catch (e) {
          document.getElementById('news-content').innerHTML = `
            <div class="page-error">
              <span style="font-size:28px">&#9888;</span>
              <span>${e.message || 'Failed to load news'}</span>
              <a onclick="Pages.news()">Retry</a>
            </div>`;
        }
      },

      async _newsRenderTech() {
        const stories = await API.fetchHNTopStories(20);
        const container = document.getElementById('news-content');

        if (!stories.length) {
          container.innerHTML = '<div class="no-games fade-in">No stories available</div>';
          return;
        }

        container.innerHTML = '<div class="news-list fade-in">' + stories.map(s => {
          const domain = s.url ? extractDomain(s.url) : 'news.ycombinator.com';
          const href = s.url || `https://news.ycombinator.com/item?id=${s.id}`;
          return `<a class="news-item" href="${href}" target="_blank" rel="noopener">
            <div class="news-title">${s.title}</div>
            <div class="news-meta">
              <span>${domain}</span>
              <span class="dot"></span>
              <span>${s.score} pts</span>
              <span class="dot"></span>
              <span>${s.descendants || 0} comments</span>
              <span class="news-time">${timeAgo(s.time)}</span>
            </div>
          </a>`;
        }).join('') + '</div>';
      },

      async _newsRenderFinance() {
        const items = await API.fetchFinanceNews();
        const container = document.getElementById('news-content');

        if (!items.length) {
          container.innerHTML = '<div class="no-games fade-in">No news available</div>';
          return;
        }

        container.innerHTML = '<div class="news-list fade-in">' + items.map(item => {
          return `<a class="news-item" href="${item.link}" target="_blank" rel="noopener">
            <div class="news-title">${item.title}</div>
            <div class="news-meta">
              <span>${item.source}</span>
              <span class="news-time">${timeAgo(item.time)}</span>
            </div>
          </a>`;
        }).join('') + '</div>';
      },

      /* ───── Calendar ───── */
      _calDate: null,

      cal() {
        const content = document.getElementById('page-content');
        if (!this._calDate) this._calDate = new Date();
        const d = this._calDate;
        const year = d.getFullYear();
        const month = d.getMonth();

        const title = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const today = new Date();
        const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

        // First day of month (0=Sun) and days in month
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrev = new Date(year, month, 0).getDate();

        const DOW = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        let cells = DOW.map(d => `<div class="cal-dow">${d}</div>`).join('');

        // Previous month trailing days
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrev - i;
          cells += `<div class="cal-day other-month${(firstDay - 1 - i) % 7 === 0 ? ' sunday' : ''}">${day}</div>`;
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
          const dayOfWeek = (firstDay + day - 1) % 7;
          const isToday = isCurrentMonth && day === today.getDate();
          const isSun = dayOfWeek === 0;
          let cls = 'cal-day';
          if (isToday) cls += ' today';
          if (isSun) cls += ' sunday';
          cells += `<div class="${cls}">${day}</div>`;
        }

        // Next month leading days
        const totalCells = firstDay + daysInMonth;
        const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let i = 1; i <= remaining; i++) {
          const isSun = (totalCells + i - 1) % 7 === 0;
          cells += `<div class="cal-day other-month${isSun ? ' sunday' : ''}">${i}</div>`;
        }

        content.innerHTML = `
          <div class="cal-header">
            <div class="cal-nav">
              <button onclick="Pages._calShift(-1)">&lsaquo;</button>
            </div>
            <span class="cal-title">${title}</span>
            <div class="cal-nav">
              <button onclick="Pages._calShift(1)">&rsaquo;</button>
            </div>
          </div>
          <div class="cal-grid fade-in">${cells}</div>`;
      },

      _calShift(delta) {
        this._calDate.setMonth(this._calDate.getMonth() + delta);
        this.cal();
      },
    };

    /* =====================================================
       APP CONTROLLER
    ===================================================== */
    const App = {
      refreshTimer: null,

      init() {
        this.applyTheme();
        this.syncPageSelect();
        this.loadPage();
        this.bindEvents();
        this.startAutoRefresh();
        this.registerSW();
      },

      applyTheme() {
        const theme = Store.get().theme;
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('theme-icon').innerHTML = theme === 'dark' ? '&#9789;' : '&#9788;';
        document.querySelector('meta[name="theme-color"]').content = theme === 'dark' ? '#0a0a0a' : '#f5f5f5';
      },

      toggleTheme() {
        Store.set({ theme: Store.get().theme === 'dark' ? 'light' : 'dark' });
        this.applyTheme();
      },

      syncPageSelect() {
        document.getElementById('page-select').value = Store.get().activePage;
      },

      loadPage() {
        const page = Store.get().activePage;
        if (Pages[page]) Pages[page]();
      },

      switchPage(page) {
        Store.set({ activePage: page });
        this.loadPage();
      },

      startAutoRefresh() {
        if (this.refreshTimer) clearInterval(this.refreshTimer);
        const mins = Store.get().refreshMinutes || 5;
        this.refreshTimer = setInterval(() => this.loadPage(), mins * 60 * 1000);
      },

      /* ───── Settings ───── */
      openSettings() {
        this.renderSettings();
        document.getElementById('settings-overlay').classList.add('open');
        document.getElementById('settings-panel').classList.add('open');
      },

      closeSettings() {
        this.saveSettingsInputs();
        document.getElementById('settings-overlay').classList.remove('open');
        document.getElementById('settings-panel').classList.remove('open');
        this.loadPage();
        this.startAutoRefresh();
      },

      saveSettingsInputs() {
        const stocksEl = document.getElementById('cfg-stocks');
        if (stocksEl) {
          const symbols = stocksEl.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
          const config = { ...Store.get().config, stocks: { symbols } };
          Store.set({ config });
        }

        const refreshEl = document.getElementById('cfg-refresh');
        if (refreshEl) {
          Store.set({ refreshMinutes: Math.max(1, parseInt(refreshEl.value) || 5) });
        }
      },

      renderSettings() {
        const state = Store.get();
        const stocks = (state.config.stocks?.symbols || DEFAULT_STATE.config.stocks.symbols).join(', ');

        document.getElementById('settings-body').innerHTML = `
          <div class="settings-section">
            <h3>Finance</h3>
            <div style="margin-bottom:16px">
              <div class="setting-label">Stock Symbols</div>
              <div class="setting-desc">Comma-separated ticker symbols</div>
              <input class="setting-input" id="cfg-stocks" value="${stocks}" placeholder="AAPL, MSFT, NVDA">
            </div>
          </div>

          <div class="settings-section">
            <h3>General</h3>
            <div class="setting-row">
              <div class="setting-label">Auto-refresh (minutes)</div>
              <input class="setting-input" type="number" min="1" max="60" id="cfg-refresh"
                value="${state.refreshMinutes || 5}" style="width:70px;text-align:center;margin:0">
            </div>
          </div>`;
      },

      /* ───── Events ───── */
      bindEvents() {
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
        document.getElementById('settings-btn').addEventListener('click', () => this.openSettings());
        document.getElementById('settings-close').addEventListener('click', () => this.closeSettings());
        document.getElementById('settings-overlay').addEventListener('click', () => this.closeSettings());
        document.getElementById('page-select').addEventListener('change', e => this.switchPage(e.target.value));
      },

      registerSW() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js').catch(() => {});
        }
      },
    };

    /* ───── Boot ───── */
    App.init();
  </script>
</body>
</html>
